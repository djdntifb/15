
(()=>{localStorage.removeItem('tt_active_timer_v3p');localStorage.removeItem('halifax_active_timer_v3');})();
function forceHideStopModal(){const m=document.getElementById('stop-modal');if(m)m.classList.add('hidden');}
document.addEventListener('DOMContentLoaded',forceHideStopModal);
if(location.search.includes('reset=1')){['tt_active_timer_v3p','halifax_active_timer_v3','halifax_active_timer_v4','halifax_store_v4_final'].forEach(k=>localStorage.removeItem(k));}
const state={currentUser:null,timer:{running:false,start:null,client:null,intervalId:null},data:null,lastInvoiceHTML:null};const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
function loadData(){fetch('assets/dummy_data.json').then(r=>r.json()).then(d=>{const local=localStorage.getItem('halifax_store_v4_final');state.data=local?JSON.parse(local):d;persist();hydrateClients();});}
function persist(){localStorage.setItem('halifax_store_v4_final',JSON.stringify(state.data));}
const fmtH=ms=>{const s=Math.floor(ms/1e3),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),ss=s%60;return`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`};const roundingMinutes=()=>state.data?.settings?.rounding_minutes??6;const roundToMinutes=ms=>{const inc=roundingMinutes();return Math.round(Math.round(ms/60000)/inc)*inc*60000};const nyDateFromLocalString=s=>new Date(s.replace(' ','T')+':00');const fmtDateStr=dISO=>new Date(dISO+'T00:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});const fmtMoney=x=>Number(x||0).toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2});const uid=p=>p+'_'+Math.random().toString(36).slice(2,10);
function show(v){['login','timer','timesheet','approvals','invoices'].forEach(x=>$('#'+x+'-view')?.classList.add('hidden'));$('#'+v+'-view')?.classList.remove('hidden');if(v!=='login')$('#nav').classList.remove('hidden');if(v==='timer')checkForResume();}
function login(){const email=$('#email').value.trim(),pass=$('#password').value.trim();const u=(state.data.users||[]).find(x=>!x.deleted&&x.email===email&&x.password===pass);if(!u)return alert('Invalid credentials');state.currentUser=u;$('#active-user').textContent=`${u.name} (${u.role})`;hydrateClients();show('timer');}
function logout(){state.currentUser=null;$('#nav').classList.add('hidden');show('login');}
const activeClients=()=>(state.data.clients||[]).filter(c=>!c.deleted);
function hydrateClients(){const fill=s=>{const el=$(s);if(!el)return;el.innerHTML='';activeClients().forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.name;el.appendChild(o);});};fill('#client-select');fill('#man-client');fill('#invoice-client');}
const activeTimerKey=()=>'halifax_active_timer_v4';const saveActiveTimer=()=>{if(!state.currentUser||!state.timer.running)return;localStorage.setItem(activeTimerKey(),JSON.stringify({user_email:state.currentUser.email,client_id:state.timer.client,start_iso:state.timer.start.toISOString()}));};const clearActiveTimer=()=>localStorage.removeItem(activeTimerKey());const formatDateTime=dt=>dt.toLocaleString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'});
function showResumeBanner(ses){const div=$('#resume-banner');const client=activeClients().find(c=>c.id===ses.client_id);div.innerHTML=`<div style="display:flex;justify-content:space-between;gap:16px;align-items:center"><div><strong>Resumed timer detected</strong><br><span class="muted">Last session for</span> <em>${client?.name||'Client'}</em> <span class="muted">started</span> ${formatDateTime(new Date(ses.start_iso))}</div><div><button id="resume-continue" class="primary">Continue</button> <button id="resume-discard" class="ghost">Discard</button></div></div>`;div.classList.remove('hidden');$('#resume-continue').onclick=()=>{state.timer.running=true;state.timer.client=ses.client_id;state.timer.start=new Date(ses.start_iso);$('#client-select').value=ses.client_id;$('#start-stop-btn').textContent='Stop';if(state.timer.intervalId)clearInterval(state.timer.intervalId);state.timer.intervalId=setInterval(()=>$('#timer-display').textContent=fmtH(new Date()-state.timer.start),500);div.classList.add('hidden');};$('#resume-discard').onclick=()=>{clearActiveTimer();state.timer={running:false,start:null,client:$('#client-select').value,intervalId:null};$('#start-stop-btn').textContent='Start';$('#timer-display').textContent='00:00:00';div.classList.add('hidden');};}
function checkForResume(){const raw=localStorage.getItem(activeTimerKey());if(!raw)return;try{const s=JSON.parse(raw);if(!s||s.user_email!==(state.currentUser&&state.currentUser.email))return;if(!state.timer.running)showResumeBanner(s);}catch(e){}}
function startStopTimer(){if(!state.currentUser)return;const btn=$('#start-stop-btn');if(!state.timer.running){const client=$('#client-select').value;state.timer.running=true;state.timer.client=client;state.timer.start=new Date();btn.textContent='Stop';state.timer.intervalId=setInterval(()=>$('#timer-display').textContent=fmtH(new Date()-state.timer.start),500);saveActiveTimer();}else{document.getElementById('stop-modal').classList.remove('hidden');}}
function saveStop(){const note=$('#work-note').value.trim();if(!note)return alert('Please enter a brief description.');document.getElementById('stop-modal').classList.add('hidden');const stopTime=new Date();clearInterval(state.timer.intervalId);const dur=stopTime-state.timer.start,rounded=roundToMinutes(dur),started=state.timer.start,stopped=new Date(started.getTime()+rounded);const c=activeClients().find(x=>x.id===state.timer.client);(state.data.time_entries=state.data.time_entries||[]).push({id:uid('t'),user_email:state.currentUser.email,client_id:state.timer.client,client_name:c?.name||'',started_at_local:started.toISOString().slice(0,16).replace('T',' '),stopped_at_local:stopped.toISOString().slice(0,16).replace('T',' '),note,status:'draft'});persist();state.timer={running:false,start:null,client:null,intervalId:null};clearActiveTimer();$('#start-stop-btn').textContent='Start';$('#timer-display').textContent='00:00:00';$('#work-note').value='';renderTimesheet();}
function wireStopModal(){const cancel=$('#cancel-stop'),save=$('#confirm-stop');if(cancel)cancel.onclick=()=>{forceHideStopModal();if(state.timer?.intervalId)clearInterval(state.timer.intervalId);state.timer={running:false,start:null,client:null,intervalId:null};clearActiveTimer();};if(save)save.onclick=saveStop;}
function addManualEntry(){const d=$('#man-date').value,st=$('#man-start').value,en=$('#man-end').value,cid=$('#man-client').value,note=$('#man-note').value.trim();if(!d||!st||!en||!cid||!note)return alert('Please complete date, start, end, client, and description.');const s=new Date(`${d}T${st}:00`),e=new Date(`${d}T${en}:00`);if(e<=s)return alert('End must be after start.');const rounded=roundToMinutes(e-s),stopped=new Date(s.getTime()+rounded);const c=activeClients().find(x=>x.id===cid);(state.data.time_entries=state.data.time_entries||[]).push({id:uid('t'),user_email:state.currentUser.email,client_id:cid,client_name:c?.name||'',started_at_local:`${d} ${st}`,stopped_at_local:`${d} ${stopped.toTimeString().slice(0,5)}`,note,status:'draft'});persist();$('#man-note').value='';$('#man-start').value='';$('#man-end').value='';renderTimesheet();}
function renderTimesheet(){const tbody=$('#timesheet-table tbody');if(!tbody)return;tbody.innerHTML='';const entries=(state.data.time_entries||[]).filter(e=>e.user_email===state.currentUser?.email);entries.sort((a,b)=>a.started_at_local.localeCompare(b.started_at_local));for(const e of entries){const st=nyDateFromLocalString(e.started_at_local),en=nyDateFromLocalString(e.stopped_at_local),hrs=(en-st)/3600000;const c=(activeClients().find(x=>x.id===e.client_id)?.name)||e.client_name;const tr=document.createElement('tr');tr.innerHTML=`<td>${fmtDateStr(e.started_at_local.slice(0,10))}</td><td>${c}</td><td>${e.started_at_local.slice(11)}</td><td>${e.stopped_at_local.slice(11)}</td><td>${hrs.toFixed(2)}</td><td>${e.status}</td><td>${e.note}</td><td>${e.status==='draft'?'<button class="ghost sm edit">Edit</button> <button class="ghost sm del">Delete</button> <button class="primary sm submit">Submit</button>':''}</td>`;tr.querySelector('.edit')?.addEventListener('click',()=>{const ns=prompt('Edit start (HH:MM)',e.started_at_local.slice(11))||e.started_at_local.slice(11);const ne=prompt('Edit end (HH:MM)',e.stopped_at_local.slice(11))||e.stopped_at_local.slice(11);const nn=prompt('Edit description',e.note)||e.note;const d=e.started_at_local.slice(0,10);if(!/^[0-2]\d:[0-5]\d$/.test(ns)||!/^[0-2]\d:[0-5]\d$/.test(ne))return alert('Invalid time format.');const s=new Date(`${d}T${ns}:00`),x=new Date(`${d}T${ne}:00`);if(x<=s)return alert('End must be after start.');const rounded=roundToMinutes(x-s),stopped=new Date(s.getTime()+rounded);e.started_at_local=`${d} ${ns}`;e.stopped_at_local=`${d} ${stopped.toTimeString().slice(0,5)}`;e.note=nn;persist();renderTimesheet();});tr.querySelector('.del')?.addEventListener('click',()=>{if(confirm('Delete entry?')){const i=state.data.time_entries.indexOf(e);state.data.time_entries.splice(i,1);persist();renderTimesheet();}});tr.querySelector('.submit')?.addEventListener('click',()=>{e.status='submitted';persist();renderTimesheet();});tbody.appendChild(tr);}}
function rateFor(email,clientId,dateISO){const rows=(state.data.rates||[]).filter(r=>r.consultant_email===email&&r.client_id===clientId);if(!rows.length)return null;const t=new Date(dateISO+'T00:00:00').getTime();const elig=rows.filter(r=>new Date(r.effective_from+'T00:00:00').getTime()<=t);if(!elig.length)return null;elig.sort((a,b)=>new Date(b.effective_from)-new Date(a.effective_from));return elig[0];}
const startOfWeekSunday=dt=>{const d=new Date(dt),day=d.getDay(),diff=(7-day)%7;const sun=new Date(d);sun.setDate(d.getDate()+diff);sun.setHours(0,0,0,0);return sun;};
function generateInvoice(){const cid=$('#invoice-client').value,mm=$('#invoice-month').value||new Date().toISOString().slice(0,7);const client=activeClients().find(c=>c.id===cid)||(state.data.clients||[]).find(c=>c.id===cid);const [yr,mo]=mm.split('-').map(n=>parseInt(n,10));const m0=new Date(yr,mo-1,1),m1=new Date(yr,mo,0);const rows=(state.data.time_entries||[]).filter(e=>e.client_id===cid&&e.status==='approved'&&nyDateFromLocalString(e.started_at_local)>=m0&&nyDateFromLocalString(e.started_at_local)<=m1);const agg={};for(const e of rows){const user=(state.data.users||[]).find(u=>u.email===e.user_email);const s=nyDateFromLocalString(e.started_at_local),x=nyDateFromLocalString(e.stopped_at_local),h=(x-s)/3600000;const key=`${user?.name||e.user_email}|${e.user_email}|${cid}|${e.started_at_local.slice(0,10)}`;if(!agg[key])agg[key]={consultant_name:user?.name||e.user_email,consultant_email:e.user_email,date:e.started_at_local.slice(0,10),hours:0,notes:[]};agg[key].hours+=h;agg[key].notes.push(e.note);}const days=Object.values(agg).sort((a,b)=>a.consultant_name.localeCompare(b.consultant_name)||a.date.localeCompare(b.date));let totalH=0,total$=0;const weekly={},daily=[];for(const r of days){const rt=rateFor(r.consultant_email,cid,r.date);if(!rt)continue;const amt=r.hours*rt.rate;totalH+=r.hours;total$+=amt;const wk=startOfWeekSunday(new Date(r.date+'T00:00:00')).toISOString().slice(0,10);if(!weekly[wk])weekly[wk]={week_ending_date:wk,hours:0,amount:0};weekly[wk].hours+=r.hours;weekly[wk].amount+=amt;daily.push({consultant:r.consultant_name,date:r.date,billable_hours:r.hours.toFixed(2),amount:amt,summary:Array.from(new Set(r.notes)).join(' ')});}const wks=Object.values(weekly).sort((a,b)=>a.week_ending_date.localeCompare(b.week_ending_date));const header=`<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px"><div><h2>${client.name}</h2><div class="muted">${client.address||''}</div><div class="muted">Terms: ${client.terms}</div><div class="muted">Invoice Month: ${mm}</div></div><img src="assets/logo.svg" style="height:40px"></div><hr>`;const weeklyTable=['<table class="table"><thead><tr><th>Week Ending</th><th>Total Billable Hours</th><th>Amount</th></tr></thead><tbody>',...wks.map(w=>`<tr><td>${fmtDateStr(w.week_ending_date)}</td><td>${w.hours.toFixed(2)}</td><td>${fmtMoney(w.amount)}</td></tr>`),`<tr><th>Total</th><th>${totalH.toFixed(2)}</th><th>${fmtMoney(total$)}</th></tr>`, '</tbody></table>'].join('');const dailyTable=['<table class="table"><thead><tr><th>Consultant</th><th>Date</th><th>Billable Hours</th><th>Amount</th><th>Summary</th></tr></thead><tbody>',...daily.map(d=>`<tr><td>${d.consultant}</td><td>${fmtDateStr(d.date)}</td><td>${d.billable_hours}</td><td>${fmtMoney(d.amount)}</td><td>${d.summary}</td></tr>`),'</tbody></table>'].join('');const html=header+weeklyTable+dailyTable;document.getElementById('invoice-output').innerHTML=html;state.lastInvoiceHTML=`<!doctype html><html><head><meta charset="utf-8"><title>Invoice</title><style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;padding:24px;color:#111}hr{border:0;border-top:1px solid #ddd;margin:12px 0}table{width:100%;border-collapse:collapse;margin-top:10px}th,td{border-bottom:1px solid #ddd;padding:8px;text-align:left}th{background:#f6f6f6}</style></head><body>${html}</body></html>`;document.getElementById('dl-invoice').disabled=document.getElementById('print-invoice').disabled=false;}
function downloadInvoice(){const blob=new Blob([state.lastInvoiceHTML||''],{type:'text/html'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='invoice.html';document.body.appendChild(a);a.click();a.remove();}
function printInvoice(){const w=window.open('','_blank');w.document.write(state.lastInvoiceHTML||'');w.document.close();w.focus();w.print();}
function initEvents(){$('#login-btn').addEventListener('click',login);$('#logout').addEventListener('click',logout);$$('#nav button[data-view]').forEach(b=>b.addEventListener('click',e=>show(e.target.getAttribute('data-view'))));$('#start-stop-btn').addEventListener('click',startStopTimer);$('#confirm-stop').addEventListener('click',saveStop);wireStopModal();$('#man-add').addEventListener('click',addManualEntry);$('#gen-invoice').addEventListener('click',generateInvoice);$('#dl-invoice').addEventListener('click',downloadInvoice);$('#print-invoice').addEventListener('click',printInvoice);}
document.addEventListener('DOMContentLoaded',()=>{loadData();initEvents();show('login');});
